name: Linguistic Quality Tests

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  deterministic-tests:
    name: Deterministic Unit Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m spacy download en_core_web_sm

    - name: Run deterministic unit tests
      run: |
        pytest tests/integration/test_linguistic_quality.py::TestAntiStutterZipperMerge -v
        pytest tests/integration/test_linguistic_quality.py::TestActionEchoDetection -v
        pytest tests/integration/test_linguistic_quality.py::TestGroundingValidation -v
        pytest tests/integration/test_linguistic_quality.py::TestPerspectiveLock -v

    - name: Test linguistic helpers
      run: |
        pytest tests/utils/linguistic_helpers.py -v

  mocked-integration-tests:
    name: Mocked Integration Tests
    runs-on: ubuntu-latest
    needs: deterministic-tests

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m spacy download en_core_web_sm

    - name: Run structural integrity tests
      run: |
        pytest tests/integration/test_structural_integrity.py -v

    - name: Run narrative flow tests
      run: |
        pytest tests/integration/test_narrative_flow.py -v

    - name: Run golden regression tests (limited)
      run: |
        # Run only first 3 golden examples for speed
        pytest tests/golden_set/test_golden_regression.py -v -k "test_golden_001 or test_golden_002 or test_golden_003" || true

    - name: Check metrics tracking
      run: |
        pytest tests/metrics/ -v || true

  all-tests:
    name: All Tests Summary
    runs-on: ubuntu-latest
    needs: [deterministic-tests, mocked-integration-tests]
    if: always()

    steps:
    - name: Test Summary
      run: |
        echo "All linguistic quality tests completed"

